<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rio do Paciente - Psi.me</title>
    
    <!-- Biblioteca para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&family=Sacramento&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* Estilos otimizados para PDF/Impress√£o */
        * {
            box-sizing: border-box;
        }
        
        body {
            background-color: white;
            font-family: 'Poppins', sans-serif;
            color: #333;
            padding: 10px;
            margin: 0;
            font-size: 11pt;
            line-height: 1.4;
        }
        
        .container-relatorio {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 15px;
            page-break-inside: avoid;
        }
        
        /* Cabe√ßalho compacto */
        .cabecalho-relatorio {
            text-align: center;
            margin-bottom: -50;
            padding-bottom: 15px;
            border-bottom: 2px solid #2c7873;
        }
        
        .cabecalho-relatorio h1 {
            color: #2c7873;
            margin-bottom: 5px;
            font-size: 1.8rem;
        }
        
        .cabecalho-relatorio p {
            color: #666;
            font-size: 0.9rem;
            margin: -50;
        }
        
        /* Layout em colunas para dados do paciente */
        .dados-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .dados-coluna {
            padding: 0;
        }
        
        /* Cards compactos */
        .info-card {
            background-color: #f8f9fa;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 12px;
            border-left: 3px solid #2c7873;
            page-break-inside: avoid;
        }
        
        .info-card h3 {
            color: #2c7873;
            margin-bottom: 10px;
            font-size: 1.1rem;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 5px;
        }
        
        .info-item {
            display: flex;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }
        
        .info-label {
            font-weight: 600;
            color: #555;
            min-width: 130px;
            flex-shrink: 0;
        }
        
        .info-value {
            color: #333;
            flex: 1;
        }
        
        /* Resumo estat√≠stico compacto */
        .resumo-estatistico {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .estatistica-card {
            background-color: white;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        
        .estatistica-valor {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2c7873;
            margin: 5px 0;
        }
        
        .estatistica-label {
            color: #666;
            font-size: 0.75rem;
        }
        
        /* Hist√≥rico compacto */
        .secao-relatorio {
            margin-bottom: 20px;
            page-break-inside: avoid;
        }
        
        .secao-titulo {
            background-color: #e9f5f4;
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 12px;
            color: #2c7873;
            font-size: 1rem;
            font-weight: 600;
            border-left: 4px solid #2c7873;
        }
        
        .historico-item {
            background-color: white;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 0.8rem;
            page-break-inside: avoid;
        }
        
        .historico-data {
            color: #2c7873;
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
        }
        
        .historico-texto {
            color: #555;
            font-size: 0.75rem;
            line-height: 1.3;
            max-height: 60px;
            overflow: hidden;
        }
        
        /* Footer compacto */
        .footer-relatorio {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
            text-align: center;
            color: #666;
            font-size: 0.75rem;
        }
        
        .assinatura {
            margin-top: 30px;
            text-align: center;
        }
        
        .linha-assinatura {
            width: 250px;
            border-top: 1px solid #333;
            margin: 20px auto 5px;
            display: inline-block;
        }
        
        /* Esconder na tela, mostrar na impress√£o */
        .print-only {
            display: none;
        }
        
        /* Bot√µes vis√≠veis apenas na tela */
        .no-print {
            display: block;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block;
            }
            .container-relatorio {
                padding: 0;
                box-shadow: none;
                border: none;
                max-width: 100%;
            }
            body {
                padding: 0;
                background: white;
                font-size: 10pt;
            }
            .info-item {
                font-size: 9pt;
            }
            .historico-texto {
                font-size: 8pt;
            }
        }
        
        /* Para a gera√ß√£o de PDF com html2pdf */
        .pdf-mode {
            background-color: white !important;
            color: black !important;
        }
        
        .pdf-mode .container-relatorio {
            box-shadow: none !important;
            border: none !important;
        }
        
        /* Bot√£o de voltar */
        .btn-voltar-relatorio {
            position: fixed;
            top: 10px;
            left: 10px;
            background-color: transparent;
            color: #2c7873;
            border: 1px solid #2c7873;
            padding: 6px 12px;
            border-radius: 5px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            z-index: 1000;
        }
        
        .btn-voltar-relatorio:hover {
            background-color: #2c7873;
            color: white;
        }
        
        /* Bot√µes de a√ß√£o */
        .botoes-relatorio {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .btn-relatorio {
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
        }
        
        .btn-relatorio:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .btn-voltar {
            background-color: #f8f9fa;
            color: #2c7873;
            border: 1px solid #2c7873;
        }
        
        .btn-voltar:hover {
            background-color: #2c7873;
            color: white;
        }
        
        .btn-imprimir {
            background-color: #2c7873;
            color: white;
        }
        
        .btn-imprimir:hover {
            background-color: #245c58;
        }
        
        .btn-pdf {
            background-color: #ff6b6b;
            color: white;
        }
        
        .btn-pdf:hover {
            background-color: #ff5252;
        }
        
        /* Loading overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2c7873;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Mensagem de erro */
        .error-message {
            background-color: #ffe6e6;
            border: 1px solid #ffcccc;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            color: #cc0000;
            font-size: 0.9rem;
        }
        
        .error-message h4 {
            margin-top: 0;
            color: #cc0000;
            font-size: 1rem;
        }
        
        .error-buttons {
            margin-top: 10px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .error-buttons button {
            padding: 8px 15px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85rem;
        }
        
        .btn-retry {
            background-color: #ff6b6b;
            color: white;
        }
        
        .btn-back {
            background-color: #6c757d;
            color: white;
        }
        
        /* Responsividade para telas pequenas */
        @media (max-width: 768px) {
            .dados-container {
                grid-template-columns: 1fr;
            }
            
            .resumo-estatistico {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .botoes-relatorio {
                flex-direction: column;
            }
            
            .btn-relatorio {
                width: 100%;
                justify-content: center;
            }
            
            .info-item {
                flex-direction: column;
            }
            
            .info-label {
                min-width: auto;
                margin-bottom: 2px;
            }
        }
        
        /* Estilos espec√≠ficos para impress√£o em uma p√°gina */
        @media print {
            @page {
                margin: 0.5cm;
                size: A4;
            }
            
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .container-relatorio {
                padding: 0;
                margin: 0;
            }
            
            .secao-relatorio {
                margin-bottom: 15px;
            }
            
            .info-card {
                margin-bottom: 8px;
                padding: 8px;
            }
            
            .historico-item {
                margin-bottom: 6px;
                padding: 6px;
            }
            
            /* Garantir que n√£o quebre p√°ginas desnecessariamente */
            .dados-container,
            .resumo-estatistico,
            .info-card,
            .historico-item {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <h3 style="color: #2c7873; margin-bottom: 10px; font-size: 1.1rem;">Carregando Relat√≥rio</h3>
        <p id="loading-message" style="color: #666; font-size: 0.9rem;">Inicializando...</p>
    </div>
    
    <!-- Bot√£o de Voltar -->
    <a href="registro.html" class="btn-voltar-relatorio no-print" onclick="voltarParaRegistro(event)">‚Üê Voltar</a>
    
    <div class="container-relatorio" id="relatorio-container">
        <!-- O conte√∫do ser√° carregado dinamicamente -->
    </div>
    
    <script>
        // ================================================
        // CONFIGURA√á√ÉO DO SUPABASE
        // ================================================
        const SUPABASE_URL = 'https://kvsdsercsgezcdymihjx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt2c2RzZXJjc2dlemNkeW1paGp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1ODcwOTIsImV4cCI6MjA4MTE2MzA5Mn0.zpcV9L44zRtWlMJlYCK_VIaNSitIpagoGT37IBonq6w';
        
        // Vari√°veis de estado
        window.supabaseClient = null;
        window.pacienteInfo = null;
        window.psicologoInfo = null;
        window.consultas = [];
        
        // ================================================
        // INICIALIZA√á√ÉO
        // ================================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Relat√≥rio: Inicializando p√°gina...');
            updateLoadingMessage('Carregando sistema...');
            
            try {
                // 1. Inicializar Supabase
                await inicializarSupabase();
                
                // 2. Carregar relat√≥rio
                await carregarRelatorio();
                
                // 3. Esconder loading
                esconderLoading();
                
                console.log('‚úÖ Relat√≥rio carregado com sucesso!');
                
            } catch (erro) {
                console.error('‚ùå Erro ao carregar relat√≥rio:', erro);
                mostrarErro(`Erro ao carregar relat√≥rio: ${erro.message}`);
            }
        });
        
        // ================================================
        // FUN√á√ïES PRINCIPAIS
        // ================================================
        
        // 1. Inicializar Supabase
        async function inicializarSupabase() {
            updateLoadingMessage('Conectando ao banco de dados...');
            
            try {
                // Verificar se a biblioteca Supabase est√° carregada
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Biblioteca Supabase n√£o carregada');
                }
                
                // Criar cliente Supabase
                window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    auth: {
                        persistSession: true,
                        autoRefreshToken: true
                    }
                });
                
                console.log('‚úÖ Supabase inicializado na p√°gina de relat√≥rio');
                
                // Testar conex√£o
                await testarConexaoSupabase();
                
            } catch (erro) {
                console.error('‚ùå Erro ao inicializar Supabase:', erro);
                throw new Error(`Falha ao conectar ao banco de dados: ${erro.message}`);
            }
        }
        
        // 2. Testar conex√£o com Supabase
        async function testarConexaoSupabase() {
            updateLoadingMessage('Testando conex√£o...');
            
            try {
                const { data, error } = await window.supabaseClient
                    .from('psicologos')
                    .select('count')
                    .limit(1);
                
                if (error) throw error;
                
                console.log('‚úÖ Conex√£o com Supabase estabelecida');
                return true;
                
            } catch (erro) {
                console.error('‚ùå Teste de conex√£o falhou:', erro);
                throw new Error('N√£o foi poss√≠vel conectar ao banco de dados');
            }
        }
        
        // 3. Carregar relat√≥rio completo
        async function carregarRelatorio() {
            updateLoadingMessage('Preparando relat√≥rio...');
            
            // Obter ID do paciente
            const pacienteId = await obterPacienteId();
            if (!pacienteId) {
                throw new Error('Nenhum paciente selecionado');
            }
            
            updateLoadingMessage('Carregando dados do paciente...');
            
            try {
                // Carregar dados do paciente
                await carregarDadosPaciente(pacienteId);
                
                updateLoadingMessage('Carregando dados do profissional...');
                
                // Carregar dados do psic√≥logo
                await carregarDadosPsicologo();
                
                updateLoadingMessage('Carregando hist√≥rico de consultas...');
                
                // Carregar consultas
                await carregarConsultas(pacienteId);
                
                updateLoadingMessage('Gerando relat√≥rio...');
                
                // Renderizar interface
                renderizarRelatorio();
                
                // Calcular estat√≠sticas
                calcularEstatisticas();
                
                // Atualizar data de emiss√£o
                atualizarDataEmissao();
                
            } catch (erro) {
                console.error('Erro no carregamento:', erro);
                throw erro;
            }
        }
        
        // 4. Obter ID do paciente
        async function obterPacienteId() {
            // Tentar da URL primeiro
            const urlParams = new URLSearchParams(window.location.search);
            let pacienteId = urlParams.get('pacienteId');
            
            // Tentar do localStorage
            if (!pacienteId) {
                try {
                    const pacienteStorage = JSON.parse(localStorage.getItem('pacienteAtual') || '{}');
                    pacienteId = pacienteStorage.id;
                    
                    if (!pacienteId) {
                        const pacienteRelatorio = JSON.parse(localStorage.getItem('pacienteParaRelatorio') || '{}');
                        pacienteId = pacienteRelatorio.id;
                    }
                } catch (erro) {
                    console.warn('Erro ao ler localStorage:', erro);
                }
            }
            
            if (!pacienteId) {
                // Mostrar interface para selecionar paciente manualmente
                mostrarSelecaoManual();
                throw new Error('ID do paciente n√£o encontrado');
            }
            
            return pacienteId;
        }
        
        // 5. Carregar dados do paciente
        async function carregarDadosPaciente(pacienteId) {
            console.log('Buscando paciente ID:', pacienteId);
            
            const { data: paciente, error } = await window.supabaseClient
                .from('pacientes')
                .select('*')
                .eq('id', pacienteId)
                .single();
            
            if (error) {
                console.error('Erro ao buscar paciente:', error);
                throw new Error('Paciente n√£o encontrado no banco de dados');
            }
            
            if (!paciente) {
                throw new Error('Paciente n√£o encontrado');
            }
            
            window.pacienteInfo = paciente;
            console.log('Paciente encontrado:', paciente.nome);
        }
        
        // 6. Carregar dados do psic√≥logo
        async function carregarDadosPsicologo() {
            // Verificar sess√£o
            let sessao = sessionStorage.getItem('psi_me_sessao') || localStorage.getItem('psi_me_sessao');
            
            if (!sessao) {
                console.warn('Nenhuma sess√£o encontrada, tentando usar dados locais...');
                
                // Tentar pegar do localStorage do script.js
                sessao = localStorage.getItem('psi_me_sessao');
                
                if (!sessao) {
                    throw new Error('Voc√™ precisa estar logado para gerar relat√≥rios');
                }
            }
            
            const psicologoLogado = JSON.parse(sessao);
            
            console.log('Buscando psic√≥logo ID:', psicologoLogado.id);
            
            const { data: psicologo, error } = await window.supabaseClient
                .from('psicologos')
                .select('*')
                .eq('id', psicologoLogado.id)
                .single();
            
            if (error) {
                console.error('Erro ao buscar psic√≥logo:', error);
                throw new Error('Dados do profissional n√£o encontrados');
            }
            
            window.psicologoInfo = psicologo;
            console.log('Psic√≥logo encontrado:', psicologo.nome_completo);
        }
        
        // 7. Carregar consultas
        async function carregarConsultas(pacienteId) {
            // Obter psic√≥logo logado
            let sessao = sessionStorage.getItem('psi_me_sessao') || localStorage.getItem('psi_me_sessao');
            const psicologoLogado = sessao ? JSON.parse(sessao) : null;
            
            if (!psicologoLogado || !psicologoLogado.id) {
                console.warn('Psic√≥logo n√£o identificado, buscando todas as consultas...');
                
                // Buscar sem filtro de psic√≥logo
                const { data: consultasData, error } = await window.supabaseClient
                    .from('consultas')
                    .select('*')
                    .eq('paciente_id', pacienteId)
                    .order('data_consulta', { ascending: false })
                    .limit(8); // Limitar a 8 consultas para caber em uma p√°gina
                
                if (error) {
                    console.warn('Erro ao buscar consultas:', error);
                    window.consultas = [];
                } else {
                    window.consultas = consultasData || [];
                }
                
            } else {
                // Buscar com filtro de psic√≥logo
                const { data: consultasData, error } = await window.supabaseClient
                    .from('consultas')
                    .select('*')
                    .eq('paciente_id', pacienteId)
                    .eq('psicologo_id', psicologoLogado.id)
                    .order('data_consulta', { ascending: false })
                    .limit(8); // Limitar a 8 consultas para caber em uma p√°gina
                
                if (error) {
                    console.warn('Erro ao buscar consultas:', error);
                    window.consultas = [];
                } else {
                    window.consultas = consultasData || [];
                }
            }
            
            console.log(`${window.consultas.length} consultas carregadas`);
        }
        
        // 8. Renderizar relat√≥rio na interface (LAYOT OTIMIZADO)
        function renderizarRelatorio() {
            const container = document.getElementById('relatorio-container');
            
            if (!container) return;
            
            const html = `
                <!-- Cabe√ßalho vis√≠vel apenas na impress√£o -->
                <div class="print-only" style="text-align: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #ccc;">
                    <h2 style="color: #2c7873; margin: 5px 0; font-size: 1.2rem;">Psi.me - Sistema de Prontu√°rio Psicol√≥gico</h2>
                    <p style="color: #666; margin: 3px 0; font-size: 0.8rem;">Relat√≥rio Confidencial - Uso Profissional</p>
                </div>
                
                <!-- Cabe√ßalho principal -->
                <div class="cabecalho-relatorio no-print">
                    <h1>Psi.me</h1>
                    <p>Relat√≥rio Psicol√≥gico do Paciente</p>
                    <p style="font-size: 0.8rem; color: #888;" id="data-emissao">Data de emiss√£o: Carregando...</p>
                </div>
                
                <div class="cabecalho-relatorio print-only">
                    <h1>Relat√≥rio Psicol√≥gico</h1>
                    <p id="data-emissao-print">Data de emiss√£o: Carregando...</p>
                </div>
                
                <!-- Dados do Paciente em duas colunas -->
                <div class="secao-relatorio">
                    <div class="secao-titulo">üìã Dados Pessoais do Paciente</div>
                    
                    <div class="dados-container">
                        <div class="dados-coluna">
                            <div class="info-card">
                                <div class="info-item">
                                    <span class="info-label">Nome Completo:</span>
                                    <span class="info-value">${window.pacienteInfo?.nome || 'N√£o informado'}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">CPF:</span>
                                    <span class="info-value">${formatarCPF(window.pacienteInfo?.cpf) || 'N√£o informado'}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Data Nasc.:</span>
                                    <span class="info-value">${formatarData(window.pacienteInfo?.nascimento) || 'N√£o informado'}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Idade:</span>
                                    <span class="info-value">${calcularIdade(window.pacienteInfo?.nascimento) || 'N√£o informado'}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Telefone:</span>
                                    <span class="info-value">${formatarTelefone(window.pacienteInfo?.telefone) || 'N√£o informado'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dados-coluna">
                            <div class="info-card">
                                <div class="info-item">
                                    <span class="info-label">E-mail:</span>
                                    <span class="info-value">${window.pacienteInfo?.email || 'N√£o informado'}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Endere√ßo:</span>
                                    <span class="info-value" style="font-size: 0.8rem;">${window.pacienteInfo?.endereco || 'N√£o informado'}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Posto:</span>
                                    <span class="info-value">${window.pacienteInfo?.posto || 'N√£o informado'}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Observa√ß√µes:</span>
                                    <span class="info-value" style="font-size: 0.8rem;">${window.pacienteInfo?.obs || 'Nenhuma observa√ß√£o registrada.'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Dados do Profissional -->
                <div class="secao-relatorio">
                    <div class="secao-titulo">üë®‚Äç‚öïÔ∏è Dados do Profissional</div>
                    
                    <div class="info-card">
                        <div class="info-item">
                            <span class="info-label">Psic√≥logo(a):</span>
                            <span class="info-value">${window.psicologoInfo?.nome_completo || 'N√£o informado'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">CRP:</span>
                            <span class="info-value">${window.psicologoInfo ? `${window.psicologoInfo.crp}/${window.psicologoInfo.estado_crp}` : 'N√£o informado'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">E-mail:</span>
                            <span class="info-value">${window.psicologoInfo?.email || 'N√£o informado'}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Resumo Estat√≠stico -->
                <div class="secao-relatorio">
                    <div class="secao-titulo">üìä Resumo do Atendimento</div>
                    
                    <div class="resumo-estatistico">
                        <div class="estatistica-card">
                            <div class="estatistica-valor" id="total-consultas">0</div>
                            <div class="estatistica-label">Total Consultas</div>
                        </div>
                        <div class="estatistica-card">
                            <div class="estatistica-valor" id="primeira-consulta">-</div>
                            <div class="estatistica-label">Primeira</div>
                        </div>
                        <div class="estatistica-card">
                            <div class="estatistica-valor" id="ultima-consulta">-</div>
                            <div class="estatistica-label">√öltima</div>
                        </div>
                        <div class="estatistica-card">
                            <div class="estatistica-valor" id="frequencia">-</div>
                            <div class="estatistica-label">Frequ√™ncia</div>
                        </div>
                    </div>
                </div>
                
                <!-- Hist√≥rico Resumido -->
                <div class="secao-relatorio">
                    <div class="secao-titulo">üìÖ Hist√≥rico de Consultas (√öltimas ${window.consultas ? window.consultas.length : 0})</div>
                    
                    <div id="lista-consultas">
                        <p style="text-align: center; padding: 15px; color: #666; font-size: 0.9rem;">Carregando hist√≥rico de consultas...</p>
                    </div>
                    
                    <div class="print-only" style="margin-top: 10px; padding: 8px; background-color: #f8f9fa; border-radius: 4px;">
                        <p style="margin: 0; font-size: 0.75rem; color: #666; font-style: italic;">
                            Este relat√≥rio apresenta um resumo das consultas. Para relatos completos, consulte o prontu√°rio digital.
                        </p>
                    </div>
                </div>
                
                <!-- Footer e Assinatura -->
                <div class="footer-relatorio print-only">
                    <div class="assinatura">
                        <div class="linha-assinatura"></div>
                        <p style="margin: 5px 0; font-size: 0.9rem;" id="psicologo-assinatura">${window.psicologoInfo?.nome_completo || ''}</p>
                        <p style="margin: 0; font-size: 0.8rem; color: #666;">CRP: <span id="psicologo-crp-assinatura">${window.psicologoInfo ? `${window.psicologoInfo.crp}/${window.psicologoInfo.estado_crp}` : ''}</span></p>
                    </div>
                    
                    <div style="margin-top: 20px; font-size: 0.7rem; color: #999;">
                        <p style="margin: 3px 0;">Documento gerado automaticamente pelo sistema Psi.me</p>
                        <p style="margin: 3px 0;">Data de emiss√£o: <span id="data-geracao">Carregando...</span></p>
                        <p style="margin: 3px 0;">Este documento √© confidencial e destinado apenas para uso profissional.</p>
                    </div>
                </div>
                
                <!-- Bot√µes de A√ß√£o (apenas na tela) -->
                <div class="botoes-relatorio no-print">
                    <button class="btn-relatorio btn-imprimir" onclick="imprimirRelatorio()">
                        üñ®Ô∏è Imprimir
                    </button>
                    <button class="btn-relatorio btn-voltar" onclick="voltarParaRegistro()">
                        ‚Üê Voltar
                    </button>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Renderizar hist√≥rico de consultas
            renderizarHistoricoConsultas();
        }
        
        // 9. Renderizar hist√≥rico de consultas (vers√£o compacta)
        function renderizarHistoricoConsultas() {
            const container = document.getElementById('lista-consultas');
            
            if (!container || !window.consultas || window.consultas.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 15px; color: #666; background-color: #f9f9f9; border-radius: 4px; font-size: 0.85rem;">
                        <p>Nenhuma consulta registrada para este paciente.</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            window.consultas.forEach(consulta => {
                const data = new Date(consulta.data_consulta);
                const dataFormatada = data.toLocaleDateString('pt-BR');
                const horaFormatada = data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                
                // Resumo do relato (m√°ximo 120 caracteres para caber melhor)
                const relatoResumido = consulta.relato.length > 120 ? 
                    consulta.relato.substring(0, 120) + '...' : 
                    consulta.relato;
                
                html += `
                <div class="historico-item">
                    <div class="historico-data">
                        <span>${dataFormatada}</span>
                        <span>${horaFormatada}</span>
                    </div>
                    <div class="historico-texto">
                        ${relatoResumido.replace(/\n/g, ' ')}
                    </div>
                </div>
                `;
            });
            
            if (window.consultas.length >= 8) {
                html += `
                <div style="text-align: center; margin-top: 10px; padding: 8px; background-color: #f0f7f6; border-radius: 4px;">
                    <p style="color: #2c7873; margin: 0; font-size: 0.75rem; font-weight: 600;">
                        Nota: Exibindo as 8 consultas mais recentes
                    </p>
                </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // 10. Calcular estat√≠sticas
        function calcularEstatisticas() {
            if (!window.consultas || window.consultas.length === 0) {
                document.getElementById('total-consultas').textContent = '0';
                document.getElementById('primeira-consulta').textContent = '-';
                document.getElementById('ultima-consulta').textContent = '-';
                document.getElementById('frequencia').textContent = '-';
                return;
            }
            
            // Total de consultas
            document.getElementById('total-consultas').textContent = window.consultas.length;
            
            // Primeira consulta (mais antiga)
            const primeiraConsulta = window.consultas.reduce((antiga, atual) => {
                return new Date(antiga.data_consulta) < new Date(atual.data_consulta) ? antiga : atual;
            });
            document.getElementById('primeira-consulta').textContent = formatarData(primeiraConsulta.data_consulta, true);
            
            // √öltima consulta (mais recente)
            const ultimaConsulta = window.consultas[0];
            document.getElementById('ultima-consulta').textContent = formatarData(ultimaConsulta.data_consulta, true);
            
            // Calcular frequ√™ncia (consultas por m√™s)
            if (window.consultas.length > 1) {
                const primeiraData = new Date(primeiraConsulta.data_consulta);
                const ultimaData = new Date(ultimaConsulta.data_consulta);
                
                const diffMeses = (ultimaData.getFullYear() - primeiraData.getFullYear()) * 12 + 
                                 (ultimaData.getMonth() - primeiraData.getMonth());
                
                if (diffMeses > 0) {
                    const frequencia = (window.consultas.length / diffMeses).toFixed(1);
                    document.getElementById('frequencia').textContent = `${frequencia}/m√™s`;
                } else {
                    document.getElementById('frequencia').textContent = `${window.consultas.length} consultas`;
                }
            } else {
                document.getElementById('frequencia').textContent = '1 consulta';
            }
        }
        
        // 11. Atualizar data de emiss√£o
        function atualizarDataEmissao() {
            const agora = new Date();
            const dataFormatada = agora.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const dataEmissaoElement = document.getElementById('data-emissao');
            const dataEmissaoPrintElement = document.getElementById('data-emissao-print');
            const dataGeracaoElement = document.getElementById('data-geracao');
            
            if (dataEmissaoElement) {
                dataEmissaoElement.textContent = `Data de emiss√£o: ${dataFormatada}`;
            }
            
            if (dataEmissaoPrintElement) {
                dataEmissaoPrintElement.textContent = `Data de emiss√£o: ${dataFormatada}`;
            }
            
            if (dataGeracaoElement) {
                dataGeracaoElement.textContent = dataFormatada;
            }
        }
        
        // ================================================
        // FUN√á√ïES AUXILIARES
        // ================================================
        
        // Fun√ß√µes de formata√ß√£o
        function formatarCPF(cpf) {
            if (!cpf) return '';
            const cpfLimpo = cpf.replace(/\D/g, '');
            if (cpfLimpo.length !== 11) return cpf;
            return cpfLimpo.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        }
        
        function formatarTelefone(telefone) {
            if (!telefone) return '';
            const telefoneLimpo = telefone.replace(/\D/g, '');
            if (telefoneLimpo.length === 11) {
                return telefoneLimpo.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            } else if (telefoneLimpo.length === 10) {
                return telefoneLimpo.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
            }
            return telefone;
        }
        
        function formatarData(dataString, short = false) {
            if (!dataString) return '';
            try {
                const data = new Date(dataString);
                if (short) {
                    return data.toLocaleDateString('pt-BR');
                }
                return data.toLocaleDateString('pt-BR');
            } catch {
                return dataString;
            }
        }
        
        function calcularIdade(dataNascimento) {
            if (!dataNascimento) return '';
            try {
                const nascimento = new Date(dataNascimento);
                const hoje = new Date();
                let idade = hoje.getFullYear() - nascimento.getFullYear();
                const mes = hoje.getMonth() - nascimento.getMonth();
                
                if (mes < 0 || (mes === 0 && hoje.getDate() < nascimento.getDate())) {
                    idade--;
                }
                
                return `${idade} anos`;
            } catch {
                return 'Data inv√°lida';
            }
        }
        
        // Fun√ß√µes de UI
        function updateLoadingMessage(mensagem) {
            const messageElement = document.getElementById('loading-message');
            if (messageElement) {
                messageElement.textContent = mensagem;
            }
            console.log('Loading:', mensagem);
        }
        
        function esconderLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }
        
        // ================================================
        // FUN√á√ïES DE A√á√ÉO
        // ================================================
        
        function voltarParaRegistro(event) {
            if (event) event.preventDefault();
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = 'registro.html';
            }
        }
        
        function imprimirRelatorio() {
            window.print();
        }
        
        async function gerarPDF() {
            try {
                const element = document.getElementById('relatorio-container');
                
                if (!element) {
                    throw new Error('Elemento do relat√≥rio n√£o encontrado');
                }
                
                // Adiciona classe para modo PDF
                element.classList.add('pdf-mode');
                
                const pacienteNome = window.pacienteInfo?.nome || 'paciente';
                const dataAtual = new Date().toISOString().split('T')[0];
                
                const opt = {
                    margin: [5, 5, 5, 5], // Margens menores: [top, right, bottom, left]
                    filename: `relatorio_${pacienteNome.replace(/\s+/g, '_')}_${dataAtual}.pdf`,
                    image: { 
                        type: 'jpeg', 
                        quality: 0.98 
                    },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#FFFFFF',
                        letterRendering: true,
                        allowTaint: true
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: 'a4', 
                        orientation: 'portrait',
                        compress: true,
                        hotfixes: ["px_scaling"]
                    },
                    pagebreak: { 
                        mode: ['avoid-all', 'css', 'legacy'] 
                    }
                };
                
                // Mostrar loading
                const btnPDF = document.querySelector('.btn-pdf');
                const originalText = btnPDF ? btnPDF.innerHTML : '';
                if (btnPDF) {
                    btnPDF.innerHTML = '‚è≥ Gerando PDF...';
                    btnPDF.disabled = true;
                }
                
                // For√ßar redimensionamento para caber em uma p√°gina
                const originalFontSize = document.body.style.fontSize;
                document.body.style.fontSize = '10pt';
                
                // Pequeno delay para aplicar os estilos
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Gerar PDF
                await html2pdf().set(opt).from(element).save();
                
                // Restaurar tamanho da fonte
                document.body.style.fontSize = originalFontSize;
                
                if (btnPDF) {
                    btnPDF.innerHTML = originalText;
                    btnPDF.disabled = false;
                }
                
                // Remover classe do modo PDF
                element.classList.remove('pdf-mode');
                
            } catch (erro) {
                console.error('Erro ao gerar PDF:', erro);
                alert('Erro ao gerar PDF. Tente a op√ß√£o de imprimir primeiro.');
                
                // Restaurar bot√£o
                const btnPDF = document.querySelector('.btn-pdf');
                if (btnPDF) {
                    btnPDF.innerHTML = 'üìÑ Gerar PDF';
                    btnPDF.disabled = false;
                }
                
                const element = document.getElementById('relatorio-container');
                if (element) {
                    element.classList.remove('pdf-mode');
                }
            }
        }
    </script>
</body>
</html>